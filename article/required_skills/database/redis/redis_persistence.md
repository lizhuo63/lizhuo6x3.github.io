# RDB(默认)

RDB机制通过创建一个经过压缩的二进制 .rdb 文件(包含各个数据库中所有的**<u>键值对数据</u>**)来达到数据持久化的目的。它提供了两种操作指令：

## SAVE（同步阻塞）

当 SAVE 指令执行成功之后，新生成的 rdb 文件会覆盖旧的 rdb。

**save的相关配置**

- 设置本地数据库文件名，默认值为 dump.rdb，通常设置为dump-端口号.rdb       dbfilename filename
- 设置存储.rdb文件的路径，通常设置成存储空间较大的目录中，目录名称data           dir path
- 设置存储至本地数据库时是否压缩数据，默认yes，设置为no，节省 CPU 运行时间，但存储文件变大         rdbcompression yes|no
- 设置读写文件过程是否进行RDB格式校验，默认yes，设置为no，节约读写10%时间消耗，但存在数据损坏的风险     rdbchecksum yes|no

### shutdown

当服务器接收到该指令时，会关闭服务。但在关停服务之前会阻塞请求，并触发 SAVE。

## BGSAVE（异步）

以 fork() 的方式创建一个子线程去执行 SAVE 指令。是对 SAVE 阻塞的优化。**

**相关配置：**

+ `save second changes` 。second 秒内有changes  个key改变，就执行bgsave。



## 总结

**缺点：**RDB 以即时存储的方式存储全量的数据快照，备份效率低而且有丢失最新数据的风险。

**优点：**然而它是一个经过压缩过的二进制文件，空间占用小，适合定点备份全量数据，恢复效率很高。【直接将 .rdb 扔到指定的dir路径即可】



# AOF（默认不开启）

是AppendOnlyFile的缩写，追加日志，通过实时记录数据的变更逻辑，并在 Redis 重启时执行追加日志来达到持久化目的。

**相关配置**

```bash
appendonly yes #开启持久化
appendfilename “appendonly.aof” #指定生成文件名称
appendfsync everysec | always | no #z
```

由于AOF日志是不断追加的，所以AOF会对影响同一个数据的若干指令进行一定的优化，一来可以降低磁盘占用，二来也能提高IO性能，三来也可以提高数据恢复的效率。

**AOF重写规制：**

1. 仅对具有时效的变更数据的指令进行记录
2. 对同一个目标键的多条指令进行优化合并

![image-20220715090538917](https://lizhuo-file.oss-cn-hangzhou.aliyuncs.com/img/image-20220715090538917.png)



## 总结

**优点：**备份效率高，不会丢失新数据

**缺点：**恢复效率低【需要全盘执行日志记录】



# 方案选择

**RDB** 适合做点数据备份【特点：数据全面，但无法保证新数据的安全性】；AOF 适合做新数据保障 【特点：能够实时记录数据的变更逻辑】

同时开启RDB和AOF,重启后，Redist优先使用AOF来恢复数据，降低数据的丢失。

+ **数据敏感型：**

  建议使用默认的AOF持久化策略，使用everysecond每秒钟记录一次。该第略redis仍可以保特很好的处理性能，当出 现问题时，最多丢失0-1秒内的数据。但由于AOF文件存储体积较大，会导致恢复速度较慢 

+ **数据呈现阶段有效性：**

  由于对新数据的安全性没有严格要求，建议使用RDB特久化方案 。数据可以良好的做到阶段内无丢失，且恢复速度较快。

+ **总而言之：**

  + **RDB：**能承受分钟级的数据丢失，用于灾难恢复
  + **AOF：**无法承受分钟级的数据丢失，，用于新数据保障


